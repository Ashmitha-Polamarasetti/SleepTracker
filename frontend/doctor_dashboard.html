<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Doctor Dashboard - SomnoCare</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        body {
            background: #f4f7fa;
            font-family: 'Segoe UI', sans-serif;
        }

        .navbar {
            background: #2c5364;
        }

        .navbar-brand {
            color: white !important;
            font-weight: bold;
        }

        .logout-btn {
            background: #dc3545;
            color: white;
        }

        .card {
            border-radius: 15px;
        }
    </style>
</head>

<body>

<nav class="navbar navbar-expand-lg">
    <div class="container-fluid">
        <span class="navbar-brand">SomnoCare - Doctor Panel</span>
        <button class="btn logout-btn" onclick="logout()">Logout</button>
    </div>
</nav>

<div class="container mt-4">

    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <h4 id="welcomeText"></h4>
            <p class="text-muted">Manage patient sleep reports and AI analysis here.</p>
        </div>
    </div>

    <div class="card shadow-sm mb-4">
        <div class="card-header bg-primary text-white">
            Registered Patients
        </div>
        <div class="card-body">
            <table class="table table-bordered table-hover">
                <thead class="table-light">
                    <tr>
                        <th>ID</th>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Gender</th>
                        <th>Phone</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="patientsTable">
                    <tr>
                        <td colspan="6" class="text-center">Loading...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <div id="reportSection" class="card shadow-sm d-none">
        <div class="card-header bg-dark text-white">
            Patient Sleep Reports & AI Analysis
        </div>
        <div class="card-body">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Heart Rate</th>
                        <th>HRV</th>
                        <th>SpO2</th>
                        <th>AHI</th>
                        <th>AI Severity</th>
                        <th>Confirmed</th>
                        <th>Notes</th>
                    </tr>
                </thead>
                <tbody id="reportTable"></tbody>
            </table>
        </div>
    </div>

</div>

<script>

const user = JSON.parse(localStorage.getItem("user"));

if (!user || user.role !== "doctor") {
    window.location.href = "doctor_login.html";
} else {
    document.getElementById("welcomeText").innerText =
        "Welcome Dr. " + user.name;
    loadPatients();
}

function logout() {
    localStorage.removeItem("user");
    window.location.href = "doctor_login.html";
}

async function loadPatients() {
    const response = await fetch("http://127.0.0.1:8000/doctor/patients");
    const patients = await response.json();

    const table = document.getElementById("patientsTable");
    table.innerHTML = "";

    patients.forEach(patient => {
        table.innerHTML += `
            <tr>
                <td>${patient.id}</td>
                <td>${patient.name}</td>
                <td>${patient.email}</td>
                <td>${patient.gender || '-'}</td>
                <td>${patient.phone_number || '-'}</td>
                <td>
                    <button class="btn btn-sm btn-success"
                        onclick="viewPatient(${patient.id})">
                        View
                    </button>
                </td>
            </tr>
        `;
    });
}

async function viewPatient(patientId) {

    const reportSection = document.getElementById("reportSection");
    const reportTable = document.getElementById("reportTable");

    reportSection.classList.remove("d-none");

    reportTable.innerHTML = `
        <tr>
            <td colspan="8">
                <div class="p-3 border rounded bg-light mb-4">
                    <h5>Upload Sleep Study Files (.hea, .dat, .apn)</h5>
                    <input type="file" id="fileInput" multiple class="form-control mb-2">
                    <button class="btn btn-success"
                        onclick="uploadFiles(${patientId})">
                        Run AI Analysis
                    </button>
                </div>
            </td>
        </tr>
    `;

    const response = await fetch(
        `http://127.0.0.1:8000/doctor/patient/${patientId}`
    );

    const reports = await response.json();

    if (reports.length === 0) {
        reportTable.innerHTML += `
            <tr>
                <td colspan="8" class="text-center">
                    No sleep sessions found
                </td>
            </tr>
        `;
        return;
    }

    reports.forEach(report => {

        reportTable.innerHTML += `
            <tr>
                <td>${report.session_date}</td>
                <td>${report.heart_rate}</td>
                <td>${report.hrv}</td>
                <td>${report.spo2}</td>
                <td>${report.ahi}</td>
                <td>${report.ai_severity}</td>
                <td>${report.confirmed_severity || '-'}</td>
                <td>${report.doctor_notes || '-'}</td>
            </tr>

            <tr>
                <td colspan="8">
                    <div id="reviewBox_${report.session_id}" class="p-3 border rounded bg-light">
                        ${report.confirmed_severity ? `
                            <h6>Doctor Review</h6>
                            <p><strong>Confirmed Severity:</strong> ${report.confirmed_severity}</p>
                            <p><strong>Notes:</strong> ${report.doctor_notes}</p>
                            <button class="btn btn-warning"
                                onclick="enableEdit(${report.session_id}, '${report.confirmed_severity}', \`${report.doctor_notes || ""}\`)">
                                Edit Review
                            </button>
                        ` : `
                            <h6>Add Review</h6>
                            <select id="severity_${report.session_id}" class="form-select mb-2">
                                <option value="">Select Severity</option>
                                <option>Mild</option>
                                <option>Moderate</option>
                                <option>Severe</option>
                            </select>

                            <textarea id="notes_${report.session_id}" 
                                class="form-control mb-2"
                                placeholder="Doctor Notes"></textarea>

                            <button class="btn btn-primary"
                                onclick="submitReview(${report.session_id})">
                                Save Review
                            </button>
                        `}
                    </div>
                </td>
            </tr>
        `;
    });
}

function enableEdit(sessionId, severity, notes) {

    const box = document.getElementById(`reviewBox_${sessionId}`);

    box.innerHTML = `
        <h6>Edit Review</h6>

        <select id="severity_${sessionId}" class="form-select mb-2">
            <option ${severity==="Mild"?"selected":""}>Mild</option>
            <option ${severity==="Moderate"?"selected":""}>Moderate</option>
            <option ${severity==="Severe"?"selected":""}>Severe</option>
        </select>

        <textarea id="notes_${sessionId}" 
            class="form-control mb-2">${notes}</textarea>

        <button class="btn btn-primary"
            onclick="submitReview(${sessionId})">
            Update Review
        </button>
    `;
}

async function uploadFiles(patientId) {

    const input = document.getElementById("fileInput");
    const button = event.target;

    if (!input.files.length) {
        alert("Please select files first.");
        return;
    }

    // ðŸ”¥ Show Loading State
    button.disabled = true;
    button.innerHTML = `
        <span class="spinner-border spinner-border-sm"></span>
        Analyzing...
    `;

    const formData = new FormData();

    for (let i = 0; i < input.files.length; i++) {
        formData.append("files", input.files[i]);
    }

    try {
        const response = await fetch(
            `http://127.0.0.1:8000/doctor/analyze/${patientId}`,
            {
                method: "POST",
                body: formData
            }
        );

        if (response.ok) {
            alert("AI Analysis Completed!");
            viewPatient(patientId);
        } else {
            alert("Analysis failed.");
        }

    } catch (error) {
        alert("Server error during upload.");
    }

    // ðŸ”¥ Restore Button
    button.disabled = false;
    button.innerHTML = "Run AI Analysis";
}

async function submitReview(sessionId) {

    const confirmedSeverity =
        document.getElementById(`severity_${sessionId}`).value;

    const notes =
        document.getElementById(`notes_${sessionId}`).value;

    if (!confirmedSeverity) {
        alert("Please select severity");
        return;
    }

    const response = await fetch(
        `http://127.0.0.1:8000/doctor/review/${sessionId}?doctor_id=${user.user_id}&notes=${encodeURIComponent(notes)}&confirmed_severity=${confirmedSeverity}`,
        { method: "POST" }
    );

    if (response.ok) {
        alert("Review saved successfully!");
        location.reload();
    } else {
        alert("Error saving review");
    }
}

</script>

</body>
</html>